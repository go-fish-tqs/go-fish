name: CI-pipeline

on:
  pull_request:
    branches: [main]

jobs:
  lighthouse:
    name: Frontend Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
          cache-dependency-path: ./frontend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Build
        run: pnpm build

      - name: Run Lighthouse CI
        # This runs the wizard, collecting data and uploading reports
        run: pnpm dlx @lhci/cli@0.13.x autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  build-test:
    name: Build & Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: "maven"

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('backend/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Build & run unit tests (Unit + Integration)
        run: mvn -B clean verify

      - name: Import JUnit XML results to Xray
        if: always()
        uses: mikepenz/xray-action@v3
        with:
          username: ${{ secrets.XRAY_CLIENT_ID }}
          password: ${{ secrets.XRAY_CLIENT_SECRET }}
          testFormat: "junit"
          projectKey: "GF"
          testPaths: "backend/target/*-reports/*.xml"
          testEnvironments: "CI"
          responseTimeout: 300000

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: backend/target/surefire-reports

  sonarcloud-analysis:
    name: Analyze (SonarCloud)
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: "maven" # built-in Maven dependency cache

      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Build and analyze with sonarcloud
        working-directory: ./backend
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
            -Dsonar.pullrequest.key=${{ github.event.pull_request.number }} \
            -Dsonar.pullrequest.branch=${{ github.head_ref }} \
            -Dsonar.pullrequest.base=${{ github.base_ref }}

  codeql-analysis:
    name: Analyze (CodeQL)
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          build-mode: none

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4

  security-audit:
    name: Security & Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: ${{ github.event.pull_request.head.sha }}
          extra_args: --debug --only-verified

      # - name: Trivy Vulnerability Scanner
      #   uses: aquasecurity/trivy-action@master
      #   with:
      #     scan-type: "fs"
      #     scan-ref: "."
      #     ignore-unfixed: true
      #     format: "table"
      #     # Only fail on CRITICAL bugs (keeps it "less rigid")
      #     exit-code: "1"
      #     severity: "CRITICAL"

  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: gofish_dev
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: dev_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Backend Setup
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: "maven"

      - name: Build Backend
        working-directory: ./backend
        run: mvn -B clean package -DskipTests

      - name: Start Backend
        working-directory: ./backend
        env:
          SPRING_PROFILES_ACTIVE: dev
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/gofish_dev
          SPRING_DATASOURCE_USERNAME: postgres
          SPRING_DATASOURCE_PASSWORD: dev_password
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
        run: |
          nohup java -jar target/*.jar > backend.log 2>&1 &
          echo "Waiting for Backend to start..."
          # Wait for port 8080 to be ready
          timeout 120s bash -c 'until curl -s http://localhost:8080/actuator/health; do sleep 5; done'
          cat backend.log

      # Frontend Setup
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
          cache-dependency-path: ./frontend/pnpm-lock.yaml

      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: pnpm install --frozen-lockfile

      - name: Install Playwright Browsers
        working-directory: ./frontend
        run: pnpm exec playwright install --with-deps

      - name: Build Frontend
        working-directory: ./frontend
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8080/api
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY }}
        run: |
          echo "Building with NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}"
          pnpm build

      - name: Start Frontend
        working-directory: ./frontend
        run: |
          nohup pnpm start > frontend.log 2>&1 &
          echo "Waiting for Frontend to start..."
          timeout 60s bash -c 'until curl -s http://localhost:3000; do sleep 2; done'

      - name: Debug - Check services
        run: |
          echo "=== Backend health check ==="
          curl -s http://localhost:8080/actuator/health || echo "Backend health check failed"
          echo ""
          echo "=== Frontend check ==="
          curl -s http://localhost:3000 | head -c 500 || echo "Frontend check failed"

      - name: Run Playwright Tests
        working-directory: ./frontend
        run: pnpm exec playwright test
        env:
          CI: true

      - name: Debug - Show logs on failure
        if: failure()
        run: |
          echo "=== Backend logs ==="
          cat backend/backend.log 2>/dev/null || echo "No backend log found"
          echo ""
          echo "=== Frontend logs ==="
          cat frontend/frontend.log 2>/dev/null || echo "No frontend log found"

      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 30
